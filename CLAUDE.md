# トモタビ - 開発ガイドライン

## サービス名
トモタビ — 「お出かけ・旅行プランを1分で作って友達と共有」

## コンセプト
- 個人の視点で切り取ったまち・旅プランを交換できるルートSNS
- 友人グループやカップルのお出かけ、旅行者の週末散策にも
- 作成→共有→現地ナビ→完了→公開、を最短で回す

## プロジェクト概要
Next.js (App Router) + React + TypeScript + Tailwind CSS + MapLibre GL JS + Supabase を使用したスマートフォン向けPWAアプリケーション

## 技術スタック

### フロントエンド
- **Next.js 14** (App Router) - React フレームワーク
- **React 18** + TypeScript 5.2 - UI ライブラリと型安全性
- **Tailwind CSS 3.3** + PostCSS - スタイリング
- **React Icons 5.5** - SVGアイコンセット

### 地図・位置情報
- **MapLibre GL JS 3.6** - オープンソース地図ライブラリ
- **OSRM API** - 経路計算サービス (`router.project-osrm.org`)
- **Nominatim API** - 地名・住所検索 (`nominatim.openstreetmap.org`)
- **Overpass API** - POI・施設検索 (`overpass-api.de`)
- **Geolocation API** - ブラウザ標準の位置情報取得

### バックエンド・データ
- **Supabase 2.38** - BaaS (認証・DB・API)
- **PostgreSQL** - リレーショナルデータベース (Supabase経由)

### 開発環境・ツール
- **TypeScript** - 厳格な型チェック有効
- **ESLint** - Next.js推奨設定
- **HTTPS開発サーバー** - local-ssl-proxy + concurrently
- **パスエイリアス** - `@/*` で絶対パス指定可能

### 開発コマンド
```bash
npm run dev          # 開発サーバー起動
npm run dev:https    # HTTPS開発サーバー起動
npm run build        # プロダクションビルド
npm run lint         # ESLintチェック
```

## 共通開発ルール

### 基本原則
- **1画面＝1ファイル完結型設計**
  - 各ページコンポーネントは単一ファイルに全て記述
  - モックAPI、型定義、ダミーデータは同一ファイル内に配置
- **依存関係最小化**
  - 外部ライブラリは最小限に留める
  - 地図表示はMapLibre GL JSのみ使用

### UI/UX設計

#### レイアウト
- **スマートフォン幅前提**: 375px〜430px
- **ヘッダー構成**:
  ```tsx
  <header className="fixed top-0 w-full z-50">
    {/* 画面タイトル */}
  </header>
  ```
- **フッター構成**:
  ```tsx
  <footer className="fixed bottom-0 w-full">
    {/* 主要CTAボタン */}
  </footer>
  ```
- **主要操作**: 片手親指で届く下部固定CTAエリアに配置

#### スタイリング
- **Tailwind CSS使用**
  - デフォルトカラーパレットのみ使用
  - 過度な装飾は禁止
  - 素朴で機能的なデザイン

#### カラールール
- **メインカラー**: `#2db5a5` - プライマリボタン、アクション要素、フォーカス状態
- **サブカラー**: `#f2b938` - セカンダリ要素、強調、バッジ
- **モノクロベース**: `gray-50`, `gray-100`, `gray-200`, `gray-300`, `gray-400`, `gray-500`, `gray-600`, `gray-700`, `gray-800`, `gray-900`, `white`, `black`
- **使用例**:
  ```tsx
  // メインカラー使用例
  style={{ backgroundColor: '#2db5a5' }}
  
  // ホバー効果（少し濃く）
  onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#239b8f'}
  
  // サブカラー使用例
  style={{ backgroundColor: '#f2b938' }}
  ```

#### アイコンルール
- **絵文字は禁止** - アプリ全体で絵文字は使用しない
- **SVGアイコン必須** - デザインの優れたSVGアイコンを使用する
- **推奨**: Heroicons、Lucide、Feather Icons等のアイコンセット
- **実装例**:
  ```tsx
  // ✅ 良い例
  <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
    <path d="M10 2L3 7v11a2 2 0 002 2h10a2 2 0 002-2V7l-7-5z"/>
  </svg>
  
  // ❌ 悪い例
  <span>🏠</span>
  ```

### アクセシビリティ
- 適切な`aria-label`の設定
- `role`属性の適用
- フォーカス管理の実装
- 日本語でのラベル記述

### 状態管理
- **ローディング状態**: 最低限の実装
- **エラー状態**: 最低限の実装
- **Supabase**: ダミー呼び出しでの実装

### ファイル構成例
```tsx
// app/[feature]/page.tsx

// 型定義
type PageData = {
  // ...
}

// ダミーデータ
const DUMMY_DATA: PageData = {
  // ...
}

// モックAPI
const mockFetchData = async (): Promise<PageData> => {
  // Supabaseダミー呼び出し
  await new Promise(resolve => setTimeout(resolve, 1000))
  return DUMMY_DATA
}

// ページコンポーネント
export default function FeaturePage() {
  // 状態管理
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  
  return (
    <>
      <header className="fixed top-0 w-full bg-white shadow-sm z-50 p-4">
        <h1>画面タイトル</h1>
      </header>
      
      <main className="pt-16 pb-20">
        {/* メインコンテンツ */}
      </main>
      
      <footer className="fixed bottom-0 w-full bg-white border-t p-4">
        <button 
          className="w-full p-3 text-white rounded"
          style={{ backgroundColor: '#2db5a5' }}
        >
          主要アクション
        </button>
      </footer>
    </>
  )
}
```

## MapLibre GL JS 使用時の注意
- 必要最小限の機能のみ使用
- スマートフォンでの操作性を考慮
- パフォーマンスに配慮した実装

## 各画面実装時のチェックリスト
- [ ] 1ファイル完結型で実装されているか
- [ ] スマートフォン幅（375-430px）で適切に表示されるか
- [ ] 主要CTAが親指で届く位置にあるか
- [ ] ローディング/エラー状態が実装されているか
- [ ] アクセシビリティ属性が設定されているか
- [ ] 日本語表記になっているか
- [ ] 過度な装飾がないか

## 画面要件定義

### 画面A：プラン作成（共有前提）
**目的：** 1分で「友だちに送れるリンク」を作る（一般公開は後でOK）

**要件：**
- ヘッダー：←｜プラン作成｜（右）下書き保存
- 本文：全画面地図＋下から編集ボトムシート
- ボトムシート項目：
  1. ルート名（任意）
  2. 所要時間（自動計算／手動で90分・半日・1日）
  3. スポットリスト（最小2件）
     - 行：番号／名称／滞在時間(分)／≡ドラッグ／×削除
     - 追加：検索入力 or 地図長押し追加
  4. メモ（任意、140字）
- フッターCTA：「共有リンクを作成」（スポット≥2で活性）
- 小リンク：「一般公開」（スポット≥3で活性）
- 振る舞い：
  - 検索→候補タップで即追加（滞在20分デフォルト）
  - 地図長押し→座標追加
  - 自動で移動時間＋滞在時間を合計表示
  - 作成時：トースト「リンクをコピーしました」＋共有シート表示

### 画面B：プラン詳細（共有リンク着地）
**目的：** 中身をすぐ理解して開始 or 保存 or リミックス

**要件：**
- ヘッダー：←｜ルート名｜（右）共有
- カバー画像（1枚 or 地図サムネ）
- メタカード（所要時間／タグ／作者名）
- ミニマップ（ポリライン＋ピン）
- スポット一覧（番号／名称／一言／サムネ）
- フッターCTA：「開始」
  - サブ：左「保存」／右「リミックス」
- 振る舞い：
  - ピンタップで該当スポットにスクロール
  - リンク閲覧はログイン不要で開始可能

### 画面C：ナビ（チェックイン）
**目的：** 「次スポットだけ」に集中し、到着は自動判定

**要件：**
- ヘッダー：←（console.log）｜ルート名＋進捗(2/5)｜（右）スキップ
- ETAバー（固定）：「次まで ◯m / ◯分」
- 地図：現在区間のみ太線／現在地＋目的地ピン
- 下部アクション領域：
  - 到着前：状態表示のみ
  - 到着時（半径30m内）：CTA「チェックイン」
  - チェックイン後：CTA「写真を追加」（任意、1枚プレビュー）
- トースト：到着時に表示→3秒後自動で次へ
- 最終到着：完了画面へ
- 振る舞い：
  - Geolocation（失敗時はダミー座標）
  - スキップ＝未達のまま次へ
  - 写真＝端末カメラ or 画像選択

### 画面D：ホーム（地図＋おすすめルート3件）
**目的：** 地図全画面＋下からスワイプで「おすすめルート3件」をカード表示

**要件：**
- 上部ヘッダー「トモタビ」だけ
- 背景はMapLibreの地図（現在地ボタンあり）
- 下部からスワイプ可能なパネルに「おすすめルート3件」（所要時間/タグ/作者名/スポット数）
- ルートカードをタップで「ルート詳細」へ onSelectRoute(id)
- 右下に丸い「＋」FAB（新規ルート作成）
- **プランマーカー**: 地図上に看板型マーカー表示（最大10個、画面内のみ、地図移動で更新）
- ローディング時は地図プレースホルダ、エラー時はトースト風表示

### 画面E：ルート完了
**目的：** 達成感の提示・作者への拍手・リミックス導線

**要件：**
- 大きめの「達成バッジ（テキストでOK）」と完了メッセージ
- 回ったスポット一覧（チェック済みアイコン）
- ボタン：①作者に拍手（単押し）②リミックスする ③ホームへ戻る

### 画面6：リミックス作成
**目的：** 既存ルートを複製し、1〜2スポット差し替えて公開

**要件：**
- 元ルートを読み込み（ダミー）、ヘッダに「リミックス」
- スポットカードの右上に「差し替え」ボタン → ミニフォーム（地図ピン/写真/名称/一言）
- タイトルは「（元タイトル）– Remix by {me}」をデフォルト提案
- 下部CTA「公開」（3スポット未満はdisabled）

## 共有コンポーネント

### BottomSheet
- 閉=96px/開=60%/ドラッグでトグル
- スワイプジェスチャー対応

### PrimaryButton
- フル幅、固定フッター対応
- 無効状態のスタイル

### Toast
- 成功/エラー表示
- 3秒後自動消去

## モックAPI/型定義

### 型定義
```typescript
type Spot = {
  id: string
  name: string
  lat: number
  lng: number
  photo?: string
  comment?: string
  stayTime?: number // 滞在時間（分）
}

type Route = {
  id: string
  title: string
  duration: '90m' | 'half' | 'day'
  tags: string[]
  author: string
  cover?: string
  spots: Spot[]
  memo?: string
  shareLink?: string
  isPublic?: boolean
}
```

### API関数
- `listRecommendedRoutes(): Promise<Route[]>` - おすすめルート一覧
- `getRoute(id): Promise<Route>` - ルート詳細取得
- `createShareLink(route): Promise<{id:string, shareLink:string}>` - 共有リンク作成
- `saveRoute(route): Promise<{id:string}>` - ルート保存
- `publishRoute(id): Promise<void>` - ルート一般公開
- `sendApplause(id): Promise<void>` - 拍手送信
- `publishRemix(route): Promise<{id:string}>` - リミックス公開

### 画面7：ユーザープロフィール
**目的：** ユーザーのプロフィール情報と作成・完了したルートを表示

**要件：**
- ヘッダー：戻る、右に「共有」（console.log）
- プロフィール：丸型アバター、名前、@handle、自己紹介
- 統計：作成ルート数 / 完了数 / フォロワー / フォロー中（クリックでconsole.log）
- アクション：自分→「編集」ボタン、他人→フォロー/解除トグル（console.log）
- タブ：作成ルート / 完了履歴 / いいね（切替可能）
- タブ内：ルートカード（カバー画像・タイトル・所要時間・タグ）タップでconsole.log
- 動作：初期タブは作成ルート、フォロー/編集は即時UI反映
- スタイル：375px幅前提、指で押しやすいUI

## 開発環境

### 開発サーバー
- **基本ルール**: 開発サーバーは基本的に開きっぱなしで運用する
- **新規起動禁止**: 既にサーバーが動いている場合は新たに`npm run dev`を実行しない
- **確認方法**: `ps aux | grep next`でプロセス確認後に判断する
- **必要時のみ再起動**: エラーや設定変更時のみサーバーを再起動する

## UI仕様

### ホーム画面のボトムシート動作
- **条件選択ボトムシート閉じる時の動作**: どの方法で閉じても必ずルート表示モードに切り替わる
  - バツボタン（✕）
  - スワイプハンドル
  - 背景タップ
  - 条件絞り込みアイコンの再タップ

### 交通手段選択UI改善 (2025-08-12)
- **対象**: ルート詳細・プラン確認画面の移動方法選択
- **Before**: 小さなセレクトボックスが右端に離れて配置
- **After**: 徒歩・車・電車の横並びアイコンボタンで直感的選択
- **改善**: セレクトボックス廃止、タップエリア拡大、メインカラー強調表示

### 日時選択UI復元・改善 (2025-08-12)
- **対象**: プラン作成画面の予定日時入力
- **Before**: 単一のdatetime-local入力フィールド
- **After**: 日にち・時・分を3列で分離表示、完全カスタムプルダウン
- **仕様**: 
  - 日にち: date型input（YYYY-MM-DD形式）
  - 時: 完全カスタムドロップダウン（0-23時、スクロール可能）
  - 分: 完全カスタムドロップダウン（00または30分のみ）
  - データ型: `scheduledDate`（日付）、`scheduledHour`（時）、`scheduledMinute`（分）に分離
- **UI改善**: 
  - ボックスと選択肢が統一されたデザイン
  - hover・selected状態の視覚フィードバック
  - 矢印アイコンの回転アニメーション
  - クリックアウトサイド・スクロール時の自動クローズ
  - 大きくて見やすい選択肢表示
- **対象ファイル**: `app/plan/create/page.tsx`, `app/plan/preview/page.tsx`

### 集合・解散スポット表示 (2025-08-12)
- **対象**: プラン作成・ルート詳細・プラン確認画面
- **仕様**: スポットリストの先頭＝集合、末尾＝解散を自動表示
- **表示ルール**: 0件→表示なし、1件→集合のみ、2件以上→集合と解散
- **UI**: 緑色チップで「集合」、赤色チップで「解散」表示
- **対象ファイル**: `app/plan/create/page.tsx`, `app/route/[id]/page.tsx`, `app/plan/preview/page.tsx`

### 所要時間の自動計算化 (2025-08-12)
- **対象**: プラン作成・プラン確認画面
- **変更**: 所要時間の手動選択を廃止、完全自動計算に変更
- **仕様**: 移動時間（徒歩75m/分）＋滞在時間で自動計算
- **表示**: グレー背景のボックスで「自動計算」と計算結果を表示
- **対象ファイル**: `app/plan/create/page.tsx`, `app/plan/preview/page.tsx`

### スポット入れ替え機能 (2025-08-12)
- **機能**: 日付区切りを考慮したドラッグ&ドロップによるスポット並び替え
- **特徴**: 
  - 日付をまたぐ移動時に日付区切り（dayBreaks）を自動調整
  - マウス・タッチ両対応の統一されたドロップ検出ロジック
  - スポット上半分→前に挿入、下半分→後ろに挿入の直感的操作
- **実装**:
  - `performSpotMove(fromIndex, toIndex)`: 日付認識対応の移動関数
  - `getDayForSpot(spotIndex, dayBreaks)`: スポットの所属日判定
  - 削除・挿入時の日付区切りインデックス自動補正
- **ドロップゾーン**: 通常・区切り後・末尾の3種類に優先順位付き検出
- **対象ファイル**: `app/plan/create/page.tsx`

### CSVプランデータ統合 (2025-08-12)
- **概要**: 1000+プランのCSVデータをアプリ内で表示・利用可能に統合
- **データソース**: `public/travel_plans.csv` (plan_id列対応、14列構造)
- **技術実装**:
  - CSVパーサー: BOM対応、plan_idベースグループ化
  - Route ID生成: `plan-{plan_id}` 形式
  - API統合: `listRecommendedRoutes()`, `getRoute(id)` でCSVデータ取得
  - キャッシュ機能: 初回読み込み後メモリ保持
- **UI表示**: ホーム画面ボトムシート「おすすめルート」に100件表示
- **対象ファイル**: `app/lib/mock-api.ts`, `app/home/page.tsx`

### 宿泊機能刷新 (2025-08-12)
- **概要**: 宿泊選択フローを極限まで簡素化し、区切りカード専用管理に変更
- **型定義変更**: `isAccommodation` → `isLodging` に統一
- **宿泊検索モード**:
  - 区切りカード「宿泊を追加」→検索バー宿泊モード切替
  - オレンジ色ホテルアイコン + 「宿泊先を検索」プレースホルダー
  - キャンセルボタンでモード解除
- **自動配置ロジック**:
  - 検索結果選択で該当日の区切り直前に自動挿入
  - 同日内既存宿泊の自動解除（置き換え）
  - dayBreaksインデックス自動調整
- **表示制限**:
  - 宿泊スポットはスポット一覧から除外（`if (spot.isLodging) return null`）
  - 区切りカードの宿泊セクションでのみ表示
  - スポット番号は宿泊除外したカウントで表示
- **宿泊管理UI**:
  - あり: 「宿泊：○○（変更｜削除）」
  - なし: 「宿泊を追加」ボタン
  - 削除=宿泊スポットのみ削除、区切りは維持
- **UX改善**:
  - 追加完了ポップアップ削除
  - 検索開始時「スポットが見つかりません」非表示
  - ワード入力後のみエラーメッセージ表示
- **対象ファイル**: `app/plan/create/page.tsx`

### iPhone14レスポンシブ最適化 (2025-08-12)
- **検索バー絞り込みアイコン修正**:
  - アイコンサイズ: `w-5 h-5` → `w-4 h-4`
  - `flex-shrink-0`と`min-w-0`でレスポンシブ対応
  - 検索ボックス内に完全収納
- **ボトムシート位置・サイズ調整**:
  - 閉じた状態: `120px` → `180px`（「おすすめルート（x件）」まで表示）
  - 開いた状態: `60%` → `65%`
  - 底面位置: `bottom: '0px'`（iPhone14 Chrome対応）
- **プラン作成ボタン位置調整**:
  - 動的位置: 閉じた状態`190px`、開いた状態`280px`
  - ボトムシートと適切な間隔を維持
- **プランマーカー時間表示統一**:
  - 全マーカーで`formatDuration()`使用
  - 適切な単位（分/時間/日数）表示
- **日付入力欄改善**:
  - 日付入力時カレンダーアイコン非表示
  - グレー表示廃止、動的色変更実装
- **コピーボタンレスポンシブ最適化**:
  - 入力フィールド: `min-w-0`、`text-ellipsis`追加
  - ボタン: `flex-shrink-0`、`min-w-[64px]`で固定
  - iPhone14で1行表示保証